<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Restablecer contraseña</title>
    <link rel="icon" type="image/x-icon" href="_href_iicon.png"/>
    <style>
        body {
            font-family: "Inter", sans-serif;
            margin: 0;
            background-color: #dd5746;
            color: #2d3e58;
            width: 100vw;
            height: 100vh;
            align-content: center;
        }

        section {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: white;
            margin: 0 auto;
            padding: 32px;
            width: 70%;
            max-width: 400px;
            border-radius: 8px;
        }

        img {
            margin-bottom: 32px;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
        }

        /* Inputs */
        input {
            background: #f8f9fa;
            color: #2d3e58;
            border-radius: 8px;
            border: 1px solid #dcdfe3;
            padding: 12px;
            box-shadow: none;
            outline: none;
        }

        input::placeholder {
            color: #a6a6a6;
        }

        input:hover {
            border-color: #b8bfc5;
        }

        input:focus {
            background: white;
            color: #2d3e58;
            border-color: #dd5746;
        }

        input:disabled {
            color: #a6a6a6;
            background: #f8f9fa;
        }

        button {
            background: #dd5746;
            color: white;
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 8px 20px;
            outline: none;
        }

        button:hover {
            background: #e96d5c;
            color: white;
        }

        button:active {
            background: #dd5746;
            color: white;
        }

        button:disabled {
            background: #dcdfe3;
            border-color: #b8bfc5;
        }
    </style>
</head>
<body>
<section>
    <img src="_href_llogo.png" alt="MARVI logo" width="192"/>

    <form>
        <label for="newPassword">Ingresa tu nueva contraseña:</label>
        <input type="password" id="newPassword" name="newPassword" placeholder="Nueva contraseña" required/>
        <button type="submit" disabled>Restablecer contraseña</button>
    </form>
</section>

<script type="module">
    import {jwtDecode} from 'https://cdn.jsdelivr.net/npm/jwt-decode@4.0.0/+esm';

    const token = window.location.pathname.split('/').pop();
    if (!token) {
        alert("Token no válido o expirado.");
        window.close();
    }

    const decoded = jwtDecode(token);
    const userType = decoded.tipo_usuario === 'usuario' ? 'users' : 'clients';
    const newPassword = document.getElementById("newPassword");
    const button = document.querySelector("button");

    newPassword.addEventListener("input", () => {
        button.disabled = newPassword.value.length < 8;
    });

    document.querySelector("form").addEventListener("submit", async (event) => {
        event.preventDefault();
        button.disabled = true;

        const data = {
            [userType === "users" ? "usuario" : "cliente"]: decoded.usuario_activo,
            contrasena: newPassword.value,
        };

        const response = await fetch(`${window.location.origin}/${userType}/password`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`,
            },
            body: JSON.stringify(data),
        });

        if (response.ok) {
            alert("Contraseña restablecida con éxito.");
            window.close();
        } else {
            alert("Error al restablecer la contraseña, enlace inválido o expirado.");
            button.disabled = false;
        }
    });
</script>
</body>
</html>
